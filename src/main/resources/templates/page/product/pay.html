<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
  <script  src="http://code.jquery.com/jquery-latest.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
    <script>
        var arrl = [];
        var productNum = document.getElementById('product_num').value;
        for (var i = 0; i < productNum.length; i++) {
            arrl[i] = productNum[i];
        }
        console.log(arrl);

        var arrl2 = [];
        var paymentStock = document.getElementById('payment_stock').value;
        for (var i = 0; i < paymentStock.length; i++) {
            arrl2[i] = paymentStock[i];
        }

        var arrl3 = [];
        var cartItemNum = document.getElementById('cartItem_num').value;
        for (var i = 0; i < cartItemNum.length; i++) {
            arrl3[i] = cartItemNum[i];
        }
        console.log(arrl3);

        console.log(payment_stock[0]);

        var lists = {
            payment_num: document.getElementById('payment_num').value,
            address: document.getElementById('address').value,
            phone: document.getElementById('phone').value,
            email: document.getElementById('email').value,
            delivery_info: document.getElementById('delivery_info').value,
            product_num: arrl,
            payment_stock: arrl2,
            cartItem_num: arrl3
        };

        console.log(product_num);
        console.log(typeof(product_num));

        const IMP = window.IMP;
        IMP.init("imp32154105");

        window.onload = function requestPay() {
            var address = document.getElementById('address').value;
            var member_No = document.getElementById('member_No').value;
            IMP.request_pay({
                pg: "html5_inicis.INIpayTest",
                pay_method: "card",
                merchant_uid: document.getElementById('payment_num').value,
                name: "결제하기",
                amount: 100, //임시
                buyer_email: document.getElementById('email').value,
                buyer_name: document.getElementById('m_name').value,
                buyer_tel: document.getElementById('phone').value,
                buyer_addr: address.split('/')[1] + address.split('/')[2],
                buyer_postcode: address.split('/')[0]
            }, function (rsp) {
                if (rsp.success) {
                    jQuery.ajax({
                        url: "/com.solponge/member/"+member_No+"/payments/su",
                        method: "post",
                        contentType: "application/json;charset=UTF-8",
                        data: JSON.stringify(lists),
                        success: function(res){
                            alert("결제 성공했습니다.");
                            location.replace("/com.solponge/member/"+member_No+"/payments/success");
                        },
                        error: function (res){
                            alert("결제 실패했습니다.");
                            location.replace("/com.solponge/member/"+member_No+"/payments/fail");
                        }
                    });
                } else {
                    window.location.href ='/com.solponge/member/'+member_No+'/payments/fail';
                }
            });
        };
        console.log("${payment_num}"+"${email}"+"${m_name}"+"${phone}");
    </script>

</head>
<body>
<input type="hidden" id="product_num" th:value="${product_num}"/>
<input type="hidden" id="payment_stock" th:value="${payment_stock}"/>
<input type="hidden" id="cartItem_num" th:value="${cartItem_num}"/>
<input type="hidden" id="payment_num" th:value="${payment_num}"/>
<input type="hidden" id="address" th:value="${address}"/>
<input type="hidden" id="phone" th:value="${phone}"/>
<input type="hidden" id="email" th:value="${email}"/>
<input type="hidden" id="delivery_info" th:value="${delivery_info}"/>
<input type="hidden" id="m_name" th:value="${m_name}"/>
<input type="hidden" id="member_No" th:value="${member_No}"/>
</body>
</html>